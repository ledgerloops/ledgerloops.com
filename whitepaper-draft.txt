OpenTabs: Trading Assets with Unknown Third Parties

Abstract:
OpenTabs is a system for trading assets with unknown third parties. A trade agreement can involve
any number of participing parties, connected in a cycle where each party only trusts one debtor and
one creditor. Rather than an alternative currency, or an alternative money system, OpenTabs can be
seen as an alternative to using money at all to settle the trade of an asset between two parties.


Introduction

Suppose Alice owns an asset which she wants to trade to Bob, receiving something in return. If Bob
does not own any assets that interest Alice (removing one-to-one barter as an option), there are
several things Alice and Bob can do. They can add more persons who are willing to
enter in a group deal to which all parties agree, and who they both trust, but such persons may not
always exist. Or Alice can accept a money payment (commodity or
fiat) from Bob, hoping to pass this money on in a future transaction (and running the risk of
devaluation). OpenTabs provides a way to establish cyclic deals for trading assets without trusting
the additional participants, and without requiring trust in a commodity, institution, or community.

Machine-readable approach:
var tasks = {
  <hash>: {
    type: MONEY_TRANSFER,
    currency: BITCOIN,
    recipient: <wallet>,
    before: <date>
  }
};

var events: {
  eventHash: {
    provider: <pubkey>,
    task: <hash>,
  },
};

var conditionalPromises = {
  <payloadHash>: {
    payload: {
      ifClause: <eventHash>,
      thenClause: <eventHash>,
    },
    conditionalPromiseHash: <payloadHash>,
    signer: <pubkey>,
    signature: <sig>
  },
  // ...
};

"If ifClause.provider promises to perform ifClause.task then I (signer) promise (or vouch) that thenClause.provider will perform thenClause.task."

Chain backward:
* For an inference rule, find the `ifClause` fields
* If an inference rule is found with a matching `thenClause` (same <eventHash> as the other rule's `ifClause`), and correct `signature` field, you can chain the two together

Chain forward:
* For an inference rule, decide if you're interested in the `thenClause` event happening.
* If so, take its `thenClause` as the `ifClause` of a new conditionalPromise. Add your own `thenClause` offer, calculate the new `payloadHash`, add yourself as the `signer`, sign the `payloadHash`, and add that as the `signature`.



If you find a cycle of which you are the signer of at least one of the conditionalPromises, make that promise unconditional:

var unconditionalPromises = {
  <payloadHash>: {
    payload: {
      ifClause: null,
      thenClause: <eventHash>,
    },
    conditionalPromiseHash: <payloadHash>,
    promiseHash: <payloadHash>,
    signer: <pubkey>,
    signature: <sig>
  },
  // ...
};

This will fulfill the ifClause of the next promise in the chain, and therefore the next, etc., until the ifClause of your own promise is also inferred. Note that ifClause is not "Once that is done", it's "Once that is promised", and so you can immediately force your provider to fulfill your if-clause by showing them the cycle.

Cyclic Contracts

A contract  between three parties will usually contain ten important parts:
* an identifier for party A
* something party A should do
* a signature by party A
* same three things for B
* same three things for C
* a statement that all parties are happy to keep their promise, and in return for it not demand anything more than each other party keeping their ends of the deal. That's to say, an agreement that all parties involved consider the trade a fair deal.

Party A hopes that parties B and C will keep their promise, and "in return", party A will keep their own promise. Party A's signature on the document serves to convince parties B and C that party A will probably keep their promise. Of course, this hope is based on the psychology and willingness to cooperate of party A,but at least the contract gives an exact definition of whether A has played by the social rules or not. This then allows other parties to either punish party A for breach of contract, or allow parties B and C to do so.

In a cyclic three-party contract, each party only trusts one of the other two parties to uphold their promise.

In this case, party A makes a promise to party B, but is not interested in the promise party B makes. However, party C is interested in party B's promise, and is willing to make a promise that interests party A.

Party A does not have to make a global statement that they think the contract is a fair deal, just that they are happy to keep their promise to B if C keep their promise to them. The contract is only binding if all parties signed it, creating a cycle of parties promising to keep their promise if the previous party does, and even if the previous party breaks the contract, that will be handled locally and does not give the losing party the right to break the contract themselves.

Simple example with two parties and time limit:
DOCUMENT A1: (Monday)
Hi Bob,
Would you be interested in an apple? I would give it to you if I receive something else that (according to my sole judgement) is of more value to me. Maybe there's something you can offer me in return?
CHeers,
Alice.

DOCUMENT B1: (Tuesday)
Hi Alice,
Yes, would you be interested in an orange? I hereby bindingly promise to give it to you on the condition that you bindingly and unconditionally promise me to give me that apple.
I have reserved the orange for you until the end of the week, in the hope we can reach an agreement in time.
Signed,
Bob.

DOCUMENT A2: (Wednesday)
Hi again Bob,
Sure, I love oranges! I successfully checked your signature on document B1. So I hereby bindingly promise you to give you that apple. I'll send it now. Let me know if it doesn't arrive!
Signed,
Alice.

DOCUMENT B2: (Thursday)
Hi again Alice,
Thanks for your promise in document A2. I hereby confirm that your signature on document A2 is correct, and it reached me yesterday, so in combination with my document B1, I am now bound to sending you the orange. I'm sending it now, let me know if the orange doesn't reach you. Looking forward to receiving your apple! :)
Signed,
Bob.


Note that both parties can still pretend that they did send the piece of fruit but it was lost in the mail, or that the fruit they hoped to receive never arrived. Bob can even fail to send document B2 and claim he never received document A2 from Alice (or received it too late), and therefore the reservation on the orange expired. So Alice and Bob still need to trust each other enough risk being lied to by the other party. Also, if either the communication channel or the delivery mechanism is unreliable, there is a chance that Bob really does receive document A2 too late (he would have to keep the orange reserved until communication with Alice is reestablished), and there is a chance that delivery fails even though the other party did everything in their power to uphold their part of the deal.

Since there are only two parties in this example, there is no need to use pseudonyms.


Longer example of a cyclic contract, with three participants (time limit and pseudonyms removed from this example for simplicity):

DOCUMENT A1: description of Alice's offer to Bob (not binding).
Hi Bob,
Would you be interested in an apple? I would give it to you if I receive something else that is of more value to me. Maybe there's something you can offer me in return, or otherwise I would also be interested in seeing what Charlie has to offer, do you know him?
Signed,
Alice.

DOCUMENT B1: description of Bob's offer to Charlie (conditionally binding).
Hi Charlie,
Would you be interested in an orange? I would give it to you if I receive something else that is of more value to me. Maybe there's something you can offer me in return, or otherwise I would also be interested in the item Alice described to me in document A1. Do you know her?
Signed,
Bob.

DOCUMENT C1: description of Charlie's offer to Alice (conditionally binding).
Hi Alice,
Would you be interested in a banana? I would give it to you if I receive something else that is of more value to me.
Maybe there's something you can offer me in return, or otherwise I would also be interested in the item Bob described in document B1. It seems you know him, because he promised me to execute on B1 on the condition that you execute on A1. Did you send him an offer by that identifier?
Signed,
Charlie.

DOCUMENT A2:
Hi again Bob,
I heard you talked to Charlie! Great. I'll give you the apple if you can prove to me that Charlie will execute on C1.
Signed,
Alice.

DOCUMENT B2:
Hi again Charlie,
I heard you sent Alice a conditionally binding offer identified as C1; I have no idea what's in there, but Alice told me she's interested
in it, so I'll give you the orange if you bindingly promise to execute on C1.
Signed,
Bob.

DOCUMENT C2:
Hi Alice (CC: Bob),
This is document C2. I hereby bindingly and unconditionally promise to execute on C1.
I'm not doing this as a charity to you, or because I want something back from you in return, but just because I'm interested in the item which Bob (CC'ed) described in B1, and in combination with B2, this now binds Bob to execute on B1. I checked Bob's signature on both documents, so I trust that they were signed by him. I've known Bob for a while now, and I trust him on his word! :)
Signed,
Charlie.

DOCUMENT B3:
Hi Charlie (CC: Alice),
Thanks for your document C2, in which you bindingly promise to execute on C1.
I have no idea what you offered Alice there, but you're right in saying that your document C2, in combination with my B2, binds me to execute on my document B1. I agree that I'm now bound to this, and it makes me happy because that, in turn, in combination with document A2, binds Alice (CC'd) to execute on A1! I checked the signatures on documents A1 and A2, and they seem to come from Alice, whom I trust. :)
Signed,
Bob.

DOCUMENT A3:
Hi Bob (CC: Charlie),
Thanks to both of you, this is a great deal which we all benefit from.
Bob, I checked Charlie's signatures on C1 and C2, and indeed, in combination with A2, this binds me to giving you the item described in A1.
Charlie, I'm looking forward to receiving your item described in C1 and C2. I checked your signatures, and trust you to give me the item soon.
Signed,
Alice.

It took 8 messages, but now everybody knows they will receive the item they're interested in, and everybody knows they're now contractually bound to sending the item they offered. Since no pseudonyms were used, this example allows Bob to test whether Charlie knows Alice, and Charlie has to leak this information to Bob in order for this flow to work.

This is the happy path, it could also be that Charlie's offer of a banana is too low for Alice, or that Alice doesn't know Charlie, or doesn't trust him to execute on his promise.

The case with 4 or more participants (say Alice, Bob, Charlie and David) is similar - then, Alice knows what she has offered to Bob, and what David offered to her, but she has no idea what Bob offered to Charlie, nor what Charlie offered to David, nor even who this Charlie person is anyway (!). She only needs to know that Charlie is some person who offers something to David in return to something he receives from Bob, and that both Bob and Charlie agree on an unforgeable identifier for Charlie, so that they can both check his signature (at no point does Alice have to check a signature from Charlie, only his direct neighbors Bob and David do).

Using pseudonyms and slightly changing the flow to obscure the length of the cycle, even less information needs to be leaked. Here is an example which has many participants, but only the communication on between two neighbors in the cycle is visible. Neither of them know how many participants there really are.
In practice you wouldn't want to give out put options without an expiry date, since it requires you to reserve your assets indefinitely while waiting for the network to find a cycle.
But for simplicity, we left the expiry date out in this example. Note that Alice and Bob don't hide their identity from each other because they need to trust each other, and not some anonymous third party, to deliver on their promises.


DOCUMENT A1:
Hi Bob,
Would you be interested in an apple? I would give it to you if I receive something else that (according to my sole judgement) is of more value to me. Maybe there's something you, or someone else, can offer me in return?
For the purpose of this offer, you can refer to me as pseudonym Mr. X, with the following public key: [...]. You can refer to the apple in question as "Object 1".
Cheers,
Alice.

DOCUMENT B1:
Hi Charlie,
Would you be interested in an orange? I will give it to you if you can prove that someone will give Mr. X (public key: ...) something he calls "Object 1".
You can refer to me as Mr. Y (public key: ...), and to the orange as "Object 2".
Signed,
Bob.

DOCUMENT C1:
Hi Alice,
If you know Mr. X, you can give him "Object 1", and if you do, I promise to give you a banana.
You can refer to me as Mr. Z1 (public key: ...) and to the banana as "Object 3".
Signed,
Charlie.

DOCUMENT C2:
Hi Bob,
That orange sounds great, I will try to get someone to satisfy Mr. X's needs.
You can refer to me as Mr. Z2 (public key: ...).
Signed,
Charlie.

DOCUMENT B2:
Hi Alice,
Thanks for sending me your offer and your temporary identity of Mr. X.
I also wanted to give you this pseudonymous promise from a certain Mr. Y [*) Bob himself, of course, but he's not reveiling this to Alice as this could leak his friendship with Charlie to her], in case it helps you to get your requirements satisfied:
> Dear Mr. Z1,
> If Mr. X receives "Object 1", then I will give you "Object 2".
> Signed,
> Mr. Y.
Signed,
Bob.

DOCUMENT A2:
Hi Charlie,
Yes, I do know Mr. X indirectly [*) this is a lie, since she herself is of course Mr. X.], and apparently a certain Mr. Y does too, who knows a certain Mr. Z1; forwarding his message:
> Dear Mr. Z1,
> If Mr. X receives "Object 1", then I will give you "Object 2".
> Signed,
> Mr. Y.
I hereby also promise you to make sure Mr. X receives "Object 1" if you promise to send me that banana.
Signed,
Alice.

DOCUMENT C3:
Hi Alice,
I hereby promise to send you the banana, so now you have to give Mr. X "Object 1", which obliges Mr. Y to give "Object 2" to Mr. Z1, and then I'll also discovered there are ways to force Mr. Z1 to transfer something to Mr. Z2 (which, as you know, is me).
Signed,
Charlie.


Protocol:
Provided you have a number of contacts, and which each of them you have a way to check their signatures, and you have a secure private communication channel for sending documents.

If you have something to offer, offer it to one of your contacts. Apart from the message text, include a message identifier (these strings would be long hashes instead of short strings like 'A1'), and a one-time identity (again, a long hash and not your real-life name 'Alice') which the contact can use to refer to you and to the documents you sent.
Now send that same one-time identity to your other contacts, so they know you're now also known as that identifier.

If you receive an offer, proceed as per the example above to try to help make it into a binding cyclic contract.

In the example above, the last documents are sent out with CC's, but that reveals to party A that party B and party C know each other and do business together. When using one-time identities, there's no need to reveal that. Of course, party A will known that party B and C know each other at least indirectly, but when talking to Bob, Charlie can pretend that he's not satisfying Alice's requirements himself, but that there's a David or even an Edward etc. in between them. Let's look at a more sophisticated example:

...
